name: Daily News Agent

on:
  schedule:
    # Run at 21:00 UTC every day (adjust timezone as needed)
    - cron: '0 21 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI
    inputs:
      feishu_only:
        description: 'Export only to Feishu (no local output)'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  run-news-agent:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Run News Agent
        env:
          # API Keys (set these in GitHub repository secrets)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
          # Feishu credentials
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_BASE_APP_TOKEN: ${{ secrets.FEISHU_BASE_APP_TOKEN }}
          FEISHU_BASE_TABLE_ID: ${{ secrets.FEISHU_BASE_TABLE_ID }}
        run: |
          echo "Starting News Agent at $(date)"
          uv run python -m news_agent.main --once --feishu-only --no-stream
          echo "News Agent completed at $(date)"

      - name: Upload logs (if any)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: news-agent-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

